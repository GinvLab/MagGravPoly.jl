#--------------------------------------------------------#
#---------------------PACKAGE-TESTS----------------------#
#--------------------------------------------------------#


using MagGravPoly.MG2D
using LinearAlgebra

########################################

function joint_testfwd1()

    # define properties of bodies
    rho = [2000.0]
    Jind = MagnetizVector(mod=[4.9],Ideg=[0.0],Ddeg=[5.0])
    Jrem = MagnetizVector(mod=[3.1],Ideg=[45.0],Ddeg=[0.0])

    # angle with the North axis
    northxax = 90.0
    
    N=30
    xzobs_mag = hcat(LinRange(0.0,1000.0,N), -10.0*ones(N))
    xzobs_grav = copy(xzobs_mag)
    
    vertices  = [350.0 500.0;
                 650.0 500.0;
                 800.0 350.0;
                 650.0 200.0;
	         350.0 200.0;
	         200.0 350.0]

    ind1 = collect(1:6)
    bodyindices = [ind1]
    pbody = JointPolygBodies2D(bodyindices,vertices,Jind,Jrem,rho,ylatext=nothing)

    ## compute grav & mag anomaly (superposition of tgrav & tmag of bodies)
    tgrav,tmag = tjointpolybodies2D(xzobs_grav,xzobs_mag,northxax,pbody)

    ##----------------------------------------------------------

    tmag_ref = [14.193946169758641,
                15.465134097160242,
                16.72349725831204,
                17.896119437998255,
                18.882841604662605,
                19.5552929225607,
                19.761258446364547,
                19.33803951376231,
                18.13893848755212,
                16.073417386944026,
                13.14929491278615,
                9.490001246463267,
                5.3050631211056825,
                0.828381498682691,
                -3.7322919606203087,
                -8.206551775465648,
                -12.43991959103446,
                -16.264930942343202,
                -19.491133582315683,
                -21.931648308925386,
                -23.459622425222438,
                -24.057279761707207,
                -23.820543273093136,
                -22.920708975705306,
                -21.554132462258433,
                -19.90468849675086,
                -18.124521072867207,
                -16.32831607465866,
                -14.595257385796268,
                -12.974629067584468]
        
    
    ## kg/m^3
    tgrav_ref =  [3.600475168234656,
                  3.9450373671440104,
                  4.3251332953639885,
                  4.7412792682747025,
                  5.192184629554951,
                  5.674017703228131,
                  6.179640472625836,
                  6.697963495128077,
                  7.213681304930219,
                  7.707753168470779,
                  8.15894411557204,
                  8.54632236945379,
                  8.851916368108949,
                  9.062441467534503,
                  9.16962482678878,
                  9.169624826788777,
                  9.062441467534487,
                  8.851916368108892,
                  8.546322369453726,
                  8.158944115571963,
                  7.7077531684706875,
                  7.213681304930125,
                  6.69796349512798,
                  6.17964047262573,
                  5.674017703228024,
                  5.192184629554854,
                  4.7412792682745915,
                  4.325133295363881,
                  3.9450373671439056,
                  3.6004751682345533]

    
    ##----------------------------------------------
    # Check if tgrav & tmag calc match tgrav & tmag ref (test passed)
    same1 = all(tmag.≈tmag_ref)
    same2 = all(tgrav.≈tgrav_ref)

    if same1 && same2
        return true
    else
        if same1
            @show tmag.-tmag_ref
            display(tmag)
        end
        if same2
            @show tgrav.-tgrav_ref
            display(tgrav)
        end
        
        return false
    end
end


#######################################################################

function joint_testfwd2()

    # define properties of bodies
    rho = [2000.0,3000.0,1000.0]
    Jind = MagnetizVector(mod=[4.9,2.5,1.1],Ideg=[0.0,0.0,0.0],Ddeg=[5.0,5.0,5.0])
    Jrem = MagnetizVector(mod=[3.1,1.0,2.0],Ideg=[45.0,-45.0,60.0],Ddeg=[0.0,50.0,35.0])

    # angle with the North axis
    northxax = 90.0
    
    N=30
    xzobs_mag = hcat(LinRange(0.0,1000.0,N), -10.0*ones(N))
    xzobs_grav = copy(xzobs_mag)

    vertices  = [390.9767752377201 130.278991954030298;         
	         430.21168888652307 130.402291449170173;  
	         430.317652312473136 140.739290679698811;  
	         430.546649812203974 130.203638738574346;  
	         430.91560484766585 130.172384962659983;  
	         440.14344907863333 130.366977100309308;  
	         440.40792260208563 140.433477629153117;  
	         440.69197601158024 130.41736322165884;   
	         430.051984435135324 120.28972077523347;   
	         410.64196146829342 110.82578388310931;   
	         400.0 100.0;                
	         510.593762919577486 120.985398228772771; 
	         520.893379913843816 110.074145035188602;  
	         530.03238448156978 100.749216912218833;  
	         530.17394928686575 100.785849813929147;  
	         530.21679397938986 100.936364994289892;  
	         530.31684510201022 100.901007653562868;  
	         520.164999382907524 90.566098324208415;   
	         510.69760101144281 100.0;                
	         600.559336241924306 250.07742274155419; 
	         650.61740252955528 250.405022500973224; 
	         660.6522482157798 240.330905878795054; 
	         660.99370462700534 220.430809598897174; 
	         670.95964200423342 200.871100638551827; 
	         680.41821282760033 200.46729028637734;  
	         670.67999306568265 200.187645182621033; 
	         670.42746927845577 190.369846341974842; 
	         650.71882888409377 170.507867891105946; 
	         650.63379439530597 160.85561419292242;  
	         650.52497931177504 140.899927178489119; 
	         640.20104498482468 120.937540781866952; 
	         620.56031603648637 110.598110231234838; 
	         600.78820427692065 100.0]

    ind1 = collect(1:11)
    ind2 = collect(12:19)
    ind3 = collect(20:33)
    bodyindices = [ind1,ind2,ind3]
    pbody = JointPolygBodies2D(bodyindices,vertices,Jind,Jrem,rho,ylatext=nothing)

    ## compute grav & mag anomaly (superposition of tgrav & tmag of bodies)
    tgrav,tmag = tjointpolybodies2D(xzobs_grav,xzobs_mag,northxax,pbody)
    
    ##----------------------------------------------------------

    tmag_ref = [0.5918318241183147,
                0.6798734039380474,
                0.7876035120749676,
                0.9209204009277164,
                1.0877618723471434,
                1.298539873837833,
                1.5657827512669085,
                1.9005975794570502,
                2.2992424909546094,
                2.706567779390114,
                2.9578526671035514,
                2.819240762991435,
                2.336636950560961,
                1.992018423803748,
                2.0381259593292147,
                2.1715139478834677,
                1.7218070372757306,
                0.05430577113881341,
                -2.5069712017681844,
                -4.669346590987333,
                -5.559089771303421,
                -5.343145827725437,
                -4.582135156107467,
                -3.696573016975904,
                -2.8889659669977217,
                -2.224157582137817,
                -1.703190449173594,
                -1.3044546251992422,
                -1.0022317303643704,
                -0.7736005479258731]
        
    ## kg/m^3
    tgrav_ref =  [0.06490031153625259,
                  0.07290055162987796,
                  0.08248754225287644,
                  0.09411175364498167,
                  0.10839115640109656,
                  0.1261826279523346,
                  0.14867540735803342,
                  0.17748210188245073,
                  0.21461156546477367,
                  0.26195847143297807,
                  0.31958443679584253,
                  0.38288069725842677,
                  0.4433355793480533,
                  0.49747595866096267,
                  0.5493006349470905,
                  0.5975409903012958,
                  0.6341179863865217,
                  0.6532893503931876,
                  0.6470672176979944,
                  0.6090610273004488,
                  0.545702134046849,
                  0.4716179424062021,
                  0.39913415466570906,
                  0.3346953433566433,
                  0.2802661805974384,
                  0.23546901750277865,
                  0.19901388977313855,
                  0.16942804245065482,
                  0.14536222124656373,
                  0.1256859444246706]


##----------------------------------------------
    # Check if tgrav & tmag calc match tgrav & tmag ref (test passed)
    same1 = all(tmag.≈tmag_ref)
    same2 = all(tgrav.≈tgrav_ref)

    if same1 && same2
        return true
    else
        if same1
            @show tmag.-tmag_ref
            display(tmag)
        end
        if same2
            @show tgrav.-tgrav_ref
            display(tgrav)
        end
        
        return false
    end
end


###############################################################

function joint_testgrad()

    ADkind = ["FWDdiff","REVdiffTAPEcomp","REVdiffTAPE"] #["FWDdiff","REVdiffTAPEcomp","REVdiffTAPE"]
    nADkind = length(ADkind)

    ##  Definition of the problem
    rho = [200.0,100.0]
    Jind = MagnetizVector(mod=[4.9,2.5],Ideg=[0.0,0.0],Ddeg=[5.0,5.0])
    Jrem = MagnetizVector(mod=[3.1,1.0],Ideg=[45.0,-45.0],Ddeg=[0.0,50.0])

    # angle with the North axis
    northxax = 90.0
    
    N=30
    xzobs_mag = hcat(LinRange(0.0,100.0,N), -1.0*ones(N))
    xzobs_grav = copy(xzobs_mag)
    
    vertices  = [35.0 90.0;
                 65.0 90.0;
                 65.0 60.0;
	         35.0 60.0;
                 35.0 50.0;
                 65.0 50.0;
                 80.0 35.0;
                 65.0 20.0;
	         35.0 20.0;
	         20.0 35.0]

    verticesref  = [45.0 100.0;
                    75.0 100.0;
                    75.0 70.0;
	            45.0 70.0;
                    45.0 60.0;
                    75.0 60.0;
                    90.0 45.0;
                    75.0 30.0;
	            45.0 30.0;
	            30.0 45.0]

    ind1 = collect(1:4)
    ind2 = collect(5:10)
    bodyindices = [ind1,ind2]

    ylatext = 500.0
    pbody = JointPolygBodies2D(bodyindices,vertices,Jind,Jrem,rho,ylatext=ylatext)
    pbodyref = JointPolygBodies2D(bodyindices,verticesref,Jind,Jrem,rho,ylatext=ylatext)

    ## compute grav & mag anomalies (superposition of tgrav & tmag of bodies)
    tgravref,tmagref = tjointpolybodies2D(xzobs_grav,xzobs_mag,northxax,pbodyref)

    # define gravmisf & magmisf structures
    Cdinv_grav = diagm(1/0.5 .* ones(length(tgravref)))
    Cdinv_mag = diagm(1/0.5 .* ones(length(tmagref)))
    
    gravmisf = Grav2DPolyMisf(bodyindices,xzobs_grav,tgravref,Cdinv_grav,:all)
    magmisf = Mag2DPolyMisf(bodyindices,northxax,xzobs_mag,tmagref,Cdinv_mag,:vertices,Jind=Jind,Jrem=Jrem)


    ∇msfref = [[15.784330115647801, -5.191589040378198, -7.1766488465165255, 19.539031821033614, 0.26829118068061236, -10.39499771246103, -31.373773251976793, -15.199613459630356, -2.6583719141966506, -1.2480847688628416, 143.0874734047118, -160.48859497625392, 219.65121820928343, -182.21248180385442, -95.61739667387462, 69.18872122779847, 3.764725134702485, -131.59817907901228, 130.60157804214424, -0.6463237677217247, 6.94576078808264e-5, 0.00018179875704277897],
               [15.784330115647805, -5.191589040378202, -7.176648846516528, 19.53903182103362, 0.2682911806806178, -10.394997712461034, -31.373773251976807, -15.199613459630337, -2.658371914196638, -1.2480847688628558, 143.08747340471183, -160.48859497625403, 219.65121820928334, -182.2124818038545, -95.61739667387462, 69.18872122779845, 3.7647251347025095, -131.59817907901234, 130.6015780421442, -0.646323767721723, 6.945760788082639e-5, 0.00018179875704277897],
               [15.784330115647805, -5.191589040378202, -7.176648846516528, 19.53903182103362, 0.2682911806806178, -10.394997712461034, -31.373773251976807, -15.199613459630337, -2.658371914196638, -1.2480847688628558, 143.08747340471183, -160.48859497625403, 219.65121820928334, -182.2124818038545, -95.61739667387462, 69.18872122779845, 3.7647251347025095, -131.59817907901234, 130.6015780421442, -0.646323767721723, 6.945760788082639e-5, 0.00018179875704277897]]


    # model parameters vector definition
    modpar = MG2D.jointstruct2vec(magmisf.whichpar,gravmisf.whichpar,pbody)
    
    sameres1 = zeros(Bool,3)
        
    for j in 1:nADkind

        autodiffstuff_mag,autodiffstuff_grav = precalcADstuffjointmaggrav(magmisf,gravmisf,ADkind[j],
                                                                          ADkind[j],modpar)
        
        println("Computing GRAV & MAG gradients...AD kind: ",ADkind[j])

        ∇msf = calc∇misfjointmaggrav(magmisf,gravmisf,ADkind[j],ADkind[j],modpar,
                                     autodiffstuff_mag,autodiffstuff_grav)

        sameres1[j] = all(∇msf.≈∇msfref[j])

    end

    if all(sameres1) 
        return true
    else
        if !all(sameres1)
            for k=1:length(sameres1)
                if sameres1[k]==false
                    println("Failed GRAV case for AutoDiff type: $(ADkind[k]))")
                end
            end
        end
        return false
    end

end

#############################################################################
