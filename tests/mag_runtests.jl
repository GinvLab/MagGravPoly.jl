#--------------------------------------------------------#
#---------------------PACKAGE-TESTS----------------------#
#--------------------------------------------------------#


using Test
using MagGrav2Dpoly
using LinearAlgebra

########################################

#function dotests()

#end

########################################

function mag_testfwd1()

    Jind = MagnetizVector(mod=[2.0],Ideg=[45.0],Ddeg=[0.0])
    Jrem = MagnetizVector(mod=[1.0],Ideg=[-45.0],Ddeg=[180.0])

    northxax = 90.0
    
    N=30
    xzobs = hcat(LinRange(0.0,1000.0,N), -10.0*ones(N))

    vertices  = [350.0 500.0;
                 650.0 500.0;
                 800.0 350.0;
                 650.0 200.0;
	         350.0 200.0;
	         200.0 350.0]

    ind1 = collect(1:6)
    bodyindices = [ind1]
    pbody = MagPolygBodies2D(bodyindices,vertices,Jind,Jrem,ylatext=nothing)

    ## compute mag anomaly (superposition of tmag of bodies)
    tmag = tmagpolybodies2D(xzobs,northxax,pbody)

    ##----------------------------------------------------------

    tmag_ref = [-8.189711012907555, -5.842646568497841, -2.6542887704005995, 1.534090993327114, 6.8633751882284715, 13.425480674481054, 21.220884008555956, 30.107352991066186, 39.751353134209275, 49.610461985430995, 58.98788444726661, 67.17398081799152, 73.61345956320483, 77.990492565214, 80.18888593663239, 80.18888593663252, 77.99049256521435, 73.61345956320551, 67.17398081799237, 58.98788444726769, 49.61046198543217, 39.75135313421054, 30.10735299106745, 21.220884008557306, 13.425480674482376, 6.863375188229655, 1.5340909933283937, -2.654288770399377, -5.842646568496609, -8.189711012906365]
               
    
    ##----------------------------------------------
    # Check if tmag calc match tmag ref (test passed)
    same = all(tmag.≈tmag_ref)
    
    if same
        return true
    else
        return false
    end
end


#######################################################################

function mag_testfwd2()

    Jind = MagnetizVector(mod=[2.0,2.0,2.0],Ideg=[45.0,45.0,45.0],Ddeg=[0.0,0.0,0.0])
    Jrem = MagnetizVector(mod=[1.0,1.0,1.0],Ideg=[-45.0,-45.0,-45.0],Ddeg=[180.0,180.0,180.0])

    northxax = 90.0
    
    N=30
    xzobs = hcat(LinRange(0.0,1000.0,N), -10.0*ones(N))

    vertices  = [390.9767752377201 130.278991954030298;         
	         430.21168888652307 130.402291449170173;  
	         430.317652312473136 140.739290679698811;  
	         430.546649812203974 130.203638738574346;  
	         430.91560484766585 130.172384962659983;  
	         440.14344907863333 130.366977100309308;  
	         440.40792260208563 140.433477629153117;  
	         440.69197601158024 130.41736322165884;   
	         430.051984435135324 120.28972077523347;   
	         410.64196146829342 110.82578388310931;   
	         400.0 100.0;                
	         510.593762919577486 120.985398228772771; 
	         520.893379913843816 110.074145035188602;  
	         530.03238448156978 100.749216912218833;  
	         530.17394928686575 100.785849813929147;  
	         530.21679397938986 100.936364994289892;  
	         530.31684510201022 100.901007653562868;  
	         520.164999382907524 90.566098324208415;   
	         510.69760101144281 100.0;                
	         600.559336241924306 250.07742274155419; 
	         650.61740252955528 250.405022500973224; 
	         660.6522482157798 240.330905878795054; 
	         660.99370462700534 220.430809598897174; 
	         670.95964200423342 200.871100638551827; 
	         680.41821282760033 200.46729028637734;  
	         670.67999306568265 200.187645182621033; 
	         670.42746927845577 190.369846341974842; 
	         650.71882888409377 170.507867891105946; 
	         650.63379439530597 160.85561419292242;  
	         650.52497931177504 140.899927178489119; 
	         640.20104498482468 120.937540781866952; 
	         620.56031603648637 110.598110231234838; 
	         600.78820427692065 100.0]

    ind1 = collect(1:11)
    ind2 = collect(12:19)
    ind3 = collect(20:33)
    bodyindices = [ind1,ind2,ind3]
    pbody = MagPolygBodies2D(bodyindices,vertices,Jind,Jrem,ylatext=[-1200,500])

    ## compute mag anomaly (superposition of tmag of bodies)
    tmag = tmagpolybodies2D(xzobs,northxax,pbody)

    ##----------------------------------------------
    tmag_ref = [-1.7801164493788955, -1.9562835535556982, -2.1511093226928897, -2.363037088479927, -2.5859756174686486, -2.8041746251239457, -2.98173334935375, -3.042209008548966, -2.8353442574623093, -2.1129946461801823, -0.6350071065031839, 1.3986534724738644, 3.134625177244807, 4.41770122142388, 6.547495603428393, 10.255226134830522, 15.038411147789915, 19.87949731093336, 22.157694208863127, 19.82645990685923, 14.343766652769082, 8.515583363881905, 3.9157124664373795, 0.8172555032652996, -1.0630877760607786, -2.1013833020344155, -2.604591535978988, -2.785890361867533, -2.782336656681401, -2.678312622373844]


    ##----------------------------------------------
    ## Check if tmag calc match tmag ref (test passed)
    same = all(tmag.≈tmag_ref)
    
    if same
        return true
    else
        return false
    end
end 

###################################################

function mag_testgrad()

    ADkind = ["FWDdiff","REVdiffTAPEcomp","REVdiffTAPE"] #["FWDdiff","REVdiffTAPEcomp","REVdiffTAPE"]
    nADkind = length(ADkind)

    ##  Definition of the problem
    Jind = MagnetizVector(mod=[2.0,1.5],Ideg=[45.0,30.0],Ddeg=[0.0,20.0])
    Jrem = MagnetizVector(mod=[1.0,0.8],Ideg=[-45.0,-15.0],Ddeg=[180.0,45.0])

    northxax = 90.0

    N=30
    xzobs = hcat(LinRange(0.0,100.0,N), -1.0*ones(N))

    vertices  = [35.0 90.0;
                 65.0 90.0;
                 65.0 60.0;
	         35.0 60.0;
                 35.0 50.0;
                 65.0 50.0;
                 80.0 35.0;
                 65.0 20.0;
	         35.0 20.0;
	         20.0 35.0]

    verticesref  = [45.0 100.0;
                    75.0 100.0;
                    75.0 70.0;
	            45.0 70.0;
                    45.0 60.0;
                    75.0 60.0;
                    90.0 45.0;
                    75.0 30.0;
	            45.0 30.0;
	            30.0 45.0]

    ind1 = collect(1:4)
    ind2 = collect(5:10)
    bodyindices = [ind1,ind2]

    ylatext = 500.0
    pbody = MagPolygBodies2D(bodyindices,vertices,Jind,Jrem,ylatext=ylatext)
    pbodyref = MagPolygBodies2D(bodyindices,verticesref,Jind,Jrem,ylatext=ylatext)

    ## compute mag anomaly (superposition of tmag of bodies)
    tmagref = tmagpolybodies2D(xzobs,northxax,pbodyref)

    # define magmisf structure
    Cdinv = diagm(1/0.5 .* ones(length(tmagref)))
    magmisf = Mag2DPolyMisf(bodyindices,northxax,xzobs,tmagref,Cdinv,:all)

    ## reference grad
    ∇msfref = [[0.0006417944849802792, -131.91360370677646, -184.2688038246861, -12.787808038729423, -298.9050201843018, 100.97983698001876, -6.183062320465799, 133.45591604900235, -733.937361345243, -737.627250238289, -399.0661100190784, 290.3235482884738, -521.6074616654713, 776.2423290725176, 161.05442998249123, 1282.325592733857, 36.27565836433448, -3572.566313964674, -1448.3224343165796, -160.77280511419684, -5021.29678661084, 27672.12122747014, -262.9144849385108, 861.1814766993293, 533.5678478268876, 3458.2502382930306, 5021.296786610843, 52036.12320681801, -87.63816164617027, 315.233808175566, -177.85594927562926, 756.6994146493197],
               [0.0006417944849680347, -131.91360370677646, -184.26880382468607, -12.787808038729414, -298.905020184302, 100.97983698001882, -6.183062320466185, 133.45591604900278, -733.9373613452428, -737.6272502382888, -399.0661100190783, 290.323548288474, -521.6074616654713, 776.2423290725175, 161.05442998249174, 1282.3255927338569, 36.27565836433469, -3572.5663139646717, -1448.32243431658, -160.772805114197, -5021.296786610835, 27672.121227470165, -262.9144849385107, 861.1814766993281, 533.5678478268878, 3458.2502382930315, 5021.2967866108365, 52036.12320681803, -87.6381616461702, 315.23380817556625, -177.85594927562923, 756.6994146493199],
               [0.0006417944849680347, -131.91360370677646, -184.26880382468607, -12.787808038729414, -298.905020184302, 100.97983698001882, -6.183062320466185, 133.45591604900278, -733.9373613452428, -737.6272502382888, -399.0661100190783, 290.323548288474, -521.6074616654713, 776.2423290725175, 161.05442998249174, 1282.3255927338569, 36.27565836433469, -3572.5663139646717, -1448.32243431658, -160.772805114197, -5021.296786610835, 27672.121227470165, -262.9144849385107, 861.1814766993281, 533.5678478268878, 3458.2502382930315, 5021.2967866108365, 52036.12320681803, -87.6381616461702, 315.23380817556625, -177.85594927562923, 756.6994146493199]]

    # model parameters vector definition
    modpar = MagGrav2Dpoly.magstruct2vec(magmisf.whichpar,pbody) 

    # gradient of misfit calculation
    ∇msf = [zeros(length(modpar)) for i=1:nADkind]

    sameres = zeros(Bool,3)
    for j in 1:nADkind

        autodiffstuff = precalcADstuffmag(magmisf,ADkind[j],modpar)

        println("Computing gradient...AD kind: ",ADkind[j])
        ∇msf[j] .= calc∇misfmag(magmisf,modpar,ADkind[j],autodiffstuff)

        sameres[j] = all(∇msf[j].≈∇msfref[j])
    end

    if all(sameres)
        return true
    else
        for k=1:length(sameres)
            if sameres[k]==false
                println("Failed for AutoDiff type: $(ADkind[k])")
            end
        end
        return false
    end
end

###############################################################################

